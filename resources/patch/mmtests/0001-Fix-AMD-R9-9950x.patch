From ddd5aa64f02d2f5ad09a84013a795d78a99f90a7 Mon Sep 17 00:00:00 2001
From: Vernon Yang <vernon2gm@gmail.com>
Date: Thu, 16 Oct 2025 14:50:13 +0800
Subject: [PATCH] Fix AMD R9 9950x

Signed-off-by: Vernon Yang <vernon2gm@gmail.com>
---
 bin/lib/MMTests/Compare.pm                 |  2 +-
 configs/config-memdb-redis-benchmark-small |  6 +++---
 configs/config-workload-kernbench-max      |  2 +-
 configs/config-workload-usemem             | 10 +++++-----
 shellpack_src/src/redis/redis-bench        |  4 ++--
 shellpack_src/src/usemem/usemem-bench      |  1 +
 6 files changed, 13 insertions(+), 12 deletions(-)

diff --git a/bin/lib/MMTests/Compare.pm b/bin/lib/MMTests/Compare.pm
index 94b0819e..a8f6d244 100644
--- a/bin/lib/MMTests/Compare.pm
+++ b/bin/lib/MMTests/Compare.pm
@@ -125,7 +125,7 @@ sub _generateComparisonTable() {
 				my $val;
 
 				$val = $extractModules[$module]->{_SummaryData}{$operation}[$extractModules[$module]->{_ComparisonStatIndex}];
-				if ($module == 0) {
+				if ($module == 0 || !defined $baselineCI{$operation}) {
 					$baselineVal = $val;
 					%baselineCI = %{$summaryCIIntervalRef};
 					push @{$significance{$operation}}, 0;
diff --git a/configs/config-memdb-redis-benchmark-small b/configs/config-memdb-redis-benchmark-small
index 8406c7af..2db22486 100644
--- a/configs/config-memdb-redis-benchmark-small
+++ b/configs/config-memdb-redis-benchmark-small
@@ -22,13 +22,13 @@ export MONITORS_WITH_LATENCY="vmstat iostat"
 export MONITOR_UPDATE_FREQUENCY=10
 
 # Redis
-export REDIS_ITERATIONS=5
+export REDIS_ITERATIONS=20
 export REDIS_PERSISTENCE="default-persist"
-export REDIS_KEYSPACE=50000
+export REDIS_KEYSPACE=2500000
 export REDIS_REQUESTS=$((REDIS_KEYSPACE*2))
 export REDIS_MEMTIER_THREADS=4
 export REDIS_PIPELINE=256
-export REDIS_MIN_CLIENTS=1
+export REDIS_MIN_CLIENTS=$((NUMCPUS-REDIS_MEMTIER_SERVER_THREADS))
 export REDIS_MAX_CLIENTS=$((NUMCPUS-REDIS_MEMTIER_SERVER_THREADS))
 
 # Disable THP as recommended by redis documentation
diff --git a/configs/config-workload-kernbench-max b/configs/config-workload-kernbench-max
index 99707dfd..fbb9d6db 100644
--- a/configs/config-workload-kernbench-max
+++ b/configs/config-workload-kernbench-max
@@ -34,4 +34,4 @@ export MMTESTS_THREAD_CUTOFF=
 # Note that, depending on your userspace/gcc/etc, a specific kernel version
 # may not be buildable. MMTests will try to sort things out automatically, but
 # if you have problems, point it to a specific version from here.
-export KERNBENCH_VERSION=6.15
+export KERNBENCH_VERSION=6.16
diff --git a/configs/config-workload-usemem b/configs/config-workload-usemem
index 266776a0..dc216b58 100644
--- a/configs/config-workload-usemem
+++ b/configs/config-workload-usemem
@@ -23,9 +23,9 @@ export MONITORS_WITH_LATENCY="vmstat iostat"
 export MONITOR_UPDATE_FREQUENCY=10
 
 # Memory consumer
-export USEMEM_WORKLOAD_SIZE=$((MEMTOTAL_BYTES/20))
-export USEMEM_PERCENTAGE_ANON=80
-export USEMEM_LOOPS=30
-export USEMEM_ITERATIONS=7
-export USEMEM_MIN_THREADS=1
+export USEMEM_WORKLOAD_SIZE=$((MEMTOTAL_BYTES))
+export USEMEM_PERCENTAGE_ANON=100
+export USEMEM_LOOPS=1
+export USEMEM_ITERATIONS=30
+export USEMEM_MIN_THREADS=$NUMCPUS
 export USEMEM_MAX_THREADS=$NUMCPUS
diff --git a/shellpack_src/src/redis/redis-bench b/shellpack_src/src/redis/redis-bench
index b63afb48..b94c653b 100755
--- a/shellpack_src/src/redis/redis-bench
+++ b/shellpack_src/src/redis/redis-bench
@@ -46,7 +46,7 @@ server_start() {
 	mmtests_activity redis-$SERVERSIDE_NAME
 	ulimit -n 15000
 	sysctl net.core.somaxconn=512
-	
+
 	monitor_pre_hook $LOGDIR_RESULTS redis-$SERVERSIDE_NAME
 	$TASKSET_SERVER redis-server $REDIS_CONF 2>&1 > $LOGDIR_RESULTS/redis-server.log &
 	REDIS_PID=$!
@@ -101,7 +101,7 @@ server_start
 	if [ $NR_THREADS -eq 1 ]; then
 		CLIENT_THREADS=1
 	fi
-	BENCH_CMD="redis-benchmark --csv -c $NR_THREADS --threads $CLIENT_THREADS -r $REDIS_KEYSPACE -n $REDIS_REQUESTS -P $REDIS_PIPELINE"
+	BENCH_CMD="redis-benchmark --csv -c $NR_THREADS --threads $CLIENT_THREADS -r $REDIS_KEYSPACE -n $REDIS_REQUESTS -P $REDIS_PIPELINE -t set"
 	log_cmd $BENCH_CMD
 	monitor_pre_hook $LOGDIR_RESULTS $NR_THREADS
 	###SHELLPACK iteration_begin $REDIS_ITERATIONS
diff --git a/shellpack_src/src/usemem/usemem-bench b/shellpack_src/src/usemem/usemem-bench
index 2ae345aa..5d475d67 100644
--- a/shellpack_src/src/usemem/usemem-bench
+++ b/shellpack_src/src/usemem/usemem-bench
@@ -52,6 +52,7 @@ echo File portion: $((MEMTOTAL_FILE/1048576))M
 				-t $NR_THREADS						\
 				-j 4096							\
 				-r $USEMEM_LOOPS					\
+				--prealloc --prefault					\
 				$((MEMTOTAL_ANON/NR_THREADS)) 2> /dev/null &
 			echo \$! >> $SHELLPACK_TEMP/usemem.pids
 		fi
-- 
2.51.0

